<?php
/*******************************************************************
* Extension name: graph-alltime_download.php                       *
*                                                                  *
* Description:    this graph extension procduces a query of the    *
* alltime downloads made by all users on a daily, monthly and      *
* yearly basis.                                                    *
*                                                                  *
* Author: Liran Tal <liran@enginx.com>                             *
*                                                                  *
*******************************************************************/


if ($type == "daily") {
	daily();
} elseif ($type == "monthly") {
	monthly();
} elseif ($type == "yearly") {
	yearly();
}



function daily() {

	include ("library/checklogin.php");
	include 'library/config.php';
	include 'library/opendb.php';

	$sql = "SELECT sum(AcctOutputOctets) as Downloads, day(AcctStartTime) AS day from radacct group by day;";

        $res = mysql_query($sql) or die('Query failed: ' . mysql_error());

	$total_downloads = 0;		// initialize variables
	$count = 0;			


        echo "<table border='2' class='table1'>\n";
        echo "
                        <thead>
                                <tr>
                                <th colspan='10'>All-time Download statistics</th>
                                </tr>
                        </thead>
                ";
        echo "<thread> <tr>
                        <th scope='col'> Downloads count in MB</th>
                        <th scope='col'> Day of month </th>
                </tr> </thread>";

        while($ent = mysql_fetch_array($res)) {

		// The table that is being procuded is in the format of:
		// +--------+------+
		// | Download | Day  |
		// +--------+------+

        	$downloads = ($ent[0]/1024/1024);	// total downloads on that specific day
        	$day = $ent[1];		// day of the month [1-31]

		$total_downloads = $total_downloads + $downloads;
		$count = $count + 1;

                echo "<tr>
                        <td> $downloads </td>
                        <td> $day </td>
                </tr>";



        }
	echo "</table>";

	echo "<br/> Total downloads of <u>$total_downloads</u> <br/>";

        mysql_free_result($res);
        include 'library/closedb.php';
}





function monthly() {

	include ("library/checklogin.php");
	include 'library/config.php';
	include 'library/opendb.php';

        
	$sql = "SELECT sum(AcctOutputOctets) as Downloads, monthname(AcctStartTime) AS month from radacct group by month;";
	$res = mysql_query($sql) or die('Query failed: ' . mysql_error());

	$total_downloads = 0;		// initialize variables
	$count = 0;			


        echo "<table border='2' class='table1'>\n";
        echo "
                        <thead>
                                <tr>
                                <th colspan='10'>All-time Download statistics</th>
                                </tr>
                        </thead>
                ";
        echo "<thread> <tr>
                        <th scope='col'> Downloads count in MB </th>
                        <th scope='col'> Month of year </th>
                </tr> </thread>";

        while($ent = mysql_fetch_array($res)) {

		// The table that is being procuded is in the format of:
		// +--------+--------+
		// | Download | Month  |
		// +--------+--------+

        	$downloads = ($ent[0]/1024/1024);	// total downloads on that specific month
        	$month = $ent[1];	// Month of year [1-12]

		$total_downloads = $total_downloads + $downloads;
		$count = $count + 1;

                echo "<tr>
                        <td> $downloads </td>
                        <td> $month </td>
                </tr>";



        }
	echo "</table>";

	echo "<br/> Total downloads of <u>$total_downloads</u> <br/>";

        mysql_free_result($res);
        include 'library/closedb.php';
}








function yearly() {

	include ("library/checklogin.php");
	include 'library/config.php';
	include 'library/opendb.php';

	$sql = "SELECT sum(AcctOutputOctets) as Downloads, year(AcctStartTime) AS year from radacct group by year;";

        $res = mysql_query($sql) or die('Query failed: ' . mysql_error());

	$total_downloads = 0;		// initialize variables
	$count = 0;			


        echo "<table border='2' class='table1'>\n";
        echo "
                        <thead>
                                <tr>
                                <th colspan='10'>All-Time Download statistics</th>
                                </tr>
                        </thead>
                ";
        echo "<thread> <tr>
                        <th scope='col'> Downloads count in MB</th>
                        <th scope='col'> Year </th>
                </tr> </thread>";

        while($ent = mysql_fetch_array($res)) {

		// The table that is being procuded is in the format of:
		// +--------+-------+
		// | Download | Year  |
		// +--------+-------+

        	$downloads = ($ent[0]/1024/1024);	// total downloads on that specific month
        	$month = $ent[1];	// Year

		$total_downloads = $total_downloads + $downloads;
		$count = $count + 1;

                echo "<tr>
                        <td> $downloads </td>
                        <td> $month </td>
                </tr>";



        }
	echo "</table>";

	echo "<br/> Total downloads of <u>$total_downloads</u> <br/>";

        mysql_free_result($res);
        include 'library/closedb.php';
}





